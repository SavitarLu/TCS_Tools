<!DOCTYPE html>
<html>
<head>
    <title>TCP Socket Client</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            display: flex;
            margin: 0;
            padding: 0;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        .sidebar {
            width: 300px;
            background-color: #f5f5f5;
            padding: 20px;
            border-right: 1px solid #ddd;
            box-sizing: border-box;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        h1 {
            margin-top: 0;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 8px 15px;
            margin-right: 10px;
        }
        #messages {
            height: calc(100vh - 60px);
            border: 1px solid #ddd;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .server-timestamp {
            color: #6b7280;
            font-size: 0.9em;
        }
        .local-timestamp {
            color: #9ca3af;
            font-size: 0.8em;
            margin-left: 10px;
        }
        .type-S {
            color: #10b981; /* [S]类型及后续内容颜色 - 浅绿色 */
        }
        .type-H {
            color: #8b5cf6; /* [H]类型及后续内容颜色 - 紫色 */
        }
        .suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-top: none;
            width: 280px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .suggestion-item {
            padding: 8px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        .ftp-status {
            margin-top: 5px;
            font-size: 0.9em;
            color: #666;
        }
    </style>
</head>
<body>
<div class="sidebar">
    <h1>TCS配置</h1>
    <div class="form-group">
        <label for="serverIp">服务器IP:</label>
        <input type="text" id="serverIp" placeholder="127.0.0.1" value="10.196.60.107">
    </div>
    <div class="form-group">
        <label for="machineId">机台号:</label>
        <div style="position: relative;">
            <input type="text" id="machineId" placeholder="输入机台号" oninput="findMachine(this.value)">
            <div id="suggestions" class="suggestions" style="display: none;"></div>
        </div>
    </div>
    <div class="form-group">
        <label for="serverPort">服务器端口:</label>
        <input type="number" id="serverPort" placeholder="自动获取端口" disabled>
    </div>
    <div class="form-group">
        <button id="loadMachineListBtn" onclick="loadMachineList()">加载机台列表</button>
        <span id="machineCount" style="margin-left: 10px;"></span>
    </div>
    <div class="form-group ftp-status">
        <span id="ftpStatus"></span>
    </div>
    <div class="form-group">
        <button id="connectBtn" onclick="connect()">连接服务器</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>断开连接</button>
    </div>
</div>

<div class="main-content">
    <h1>消息显示</h1>
    <div id="messages"></div>
</div>

<script>
    var stompClient = null;
    var socket = null;
    var connectionId = null;
    var machineMap = {}; // 机台号到端口的映射
    var allMachineIds = []; // 所有机台号列表

    // 使用FTP协议获取远程文件
    // 通过后端API获取机台列表
    function loadMachineList() {
        // 指向SSH获取文件的API端点
        const apiUrl = 'http://10.196.61.10:9070/api/ssh/fetch'; // 请根据实际端口修改

        updateFtpStatus('正在通过SSH获取机台列表...');

        fetch(apiUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`API请求失败，状态码: ${response.status}`);
                }
                return response.text();
            })
            .then(data => {
                // 检查是否为错误信息
                if (data.startsWith('SSH连接失败') || data.startsWith('SFTP操作失败') || data.startsWith('文件不存在')) {
                    throw new Error(data);
                }

                updateFtpStatus('文件下载完成，正在解析...');
                // 解析数据
                parseMachineData(data);

                updateFtpStatus(`成功加载 ${allMachineIds.length} 个机台配置`);
                document.getElementById('machineCount').textContent = `已加载: ${allMachineIds.length} 个`;
                appendMessage(`成功加载 ${allMachineIds.length} 个机台配置`);
            })
            .catch(error => {
                console.error('获取机台列表失败:', error);
                updateFtpStatus('获取机台列表失败: ' + error.message);
                appendMessage('获取机台列表失败: ' + error.message);
            });
    }

    // 更新FTP状态显示
    function updateFtpStatus(message) {
        const statusElement = document.getElementById('ftpStatus');
        statusElement.textContent = message;
        statusElement.className = 'ftp-status';

        // 错误信息显示为红色
        if (message.includes('失败')) {
            statusElement.classList.add('error');
        }
    }

    // 解析机台数据
    function parseMachineData(data) {
        machineMap = {};
        allMachineIds = [];

        // 按行分割数据
        const lines = data.split('\n');
        let isDataSection = false;

        lines.forEach(line => {
            // 跳过空行和注释行
            if (!line.trim() || line.startsWith('#') || line.includes('EQP-ID') || line.includes('--------------')) {
                if (line.includes('EQP-ID')) {
                    isDataSection = true; // 标记数据部分开始
                }
                return;
            }

            if (isDataSection) {
                // 解析EQP-ID和端口号
                const parts = line.split(/\s+/);
                if (parts.length >= 3) {
                    const eqpId = parts[0];
                    const port = parts[parts.length - 1];

                    machineMap[eqpId] = port;
                    allMachineIds.push(eqpId);
                }
            }
        });
    }

    // 查找机台并显示建议
    function findMachine(input) {
        if (!input.trim()) {
            hideSuggestions();
            document.getElementById('serverPort').value = '';
            document.getElementById('serverPort').disabled = true;
            return;
        }

        // 过滤匹配的机台号
        const suggestions = allMachineIds.filter(id => id.toLowerCase().includes(input.toLowerCase()));

        if (suggestions.length === 0) {
            hideSuggestions();
            document.getElementById('serverPort').value = '';
            document.getElementById('serverPort').disabled = true;
            return;
        }

        // 显示建议
        showSuggestions(suggestions);

        // 如果只有一个匹配项，自动填充并获取端口
        if (suggestions.length === 1) {
            document.getElementById('machineId').value = suggestions[0];
            getPortForMachine(suggestions[0]);
            hideSuggestions();
        }
    }

    // 显示建议列表
    function showSuggestions(suggestions) {
        const suggestionsDiv = document.getElementById('suggestions');
        suggestionsDiv.innerHTML = '';

        suggestions.forEach(suggestion => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            item.textContent = suggestion;
            item.onclick = () => {
                document.getElementById('machineId').value = suggestion;
                getPortForMachine(suggestion);
                hideSuggestions();
            };
            suggestionsDiv.appendChild(item);
        });

        suggestionsDiv.style.display = 'block';
    }

    // 隐藏建议列表
    function hideSuggestions() {
        document.getElementById('suggestions').style.display = 'none';
    }

    // 获取机台对应的端口号
    function getPortForMachine(machineId) {
        const port = machineMap[machineId];
        if (port) {
            document.getElementById('serverPort').value = port;
            document.getElementById('serverPort').disabled = false;
        } else {
            document.getElementById('serverPort').value = '';
            document.getElementById('serverPort').disabled = true;
        }
    }

    // 点击页面其他地方隐藏建议
    document.addEventListener('click', (event) => {
        const machineIdInput = document.getElementById('machineId');
        const suggestionsDiv = document.getElementById('suggestions');

        if (!machineIdInput.contains(event.target) && !suggestionsDiv.contains(event.target)) {
            hideSuggestions();
        }
    });

    function connect() {
        var serverIp = document.getElementById('serverIp').value;
        var serverPort = document.getElementById('serverPort').value;

        if (!serverIp || !serverPort) {
            appendMessage("请输入服务器IP和端口");
            return;
        }

        appendMessage("正在连接到服务器: " + serverIp + ":" + serverPort);

        socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('Connected to WebSocket: ' + frame);
            appendMessage("已连接到本地代理");

            stompClient.subscribe('/topic/messages', function(message) {
                appendMessage(message.body);
            });

            stompClient.send("/app/connect", {}, serverIp + ":" + serverPort);

            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('message').disabled = false;
            document.getElementById('sendBtn').disabled = false;
        }, function(error) {
            appendMessage('连接失败: ' + error);
            console.error('WebSocket error:', error);
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            if (connectionId) {
                stompClient.send("/app/disconnect", {}, connectionId);
            }
            stompClient.disconnect();
            appendMessage("已断开连接");
        }
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        document.getElementById('message').disabled = true;
        document.getElementById('sendBtn').disabled = true;
        stompClient = null;
        connectionId = null;
    }

    function sendMessage() {
        var message = document.getElementById('message').value;
        if (message && stompClient) {
            stompClient.send("/app/send", {}, message);
            appendMessage("发送: " + message);
            document.getElementById('message').value = '';
        }
    }

    function appendMessage(message) {
        // 转义特殊HTML字符
        message = message
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');

        // 提取服务器时间戳（格式: YYYY-MM-DD-HH.mm.ss.fff）
        var serverTimestampMatch = message.match(/^(\d{4}-\d{2}-\d{2}-\d{2}\.\d{2}\.\d{2}\.\d{3})\s+/);
        var serverTimestamp = '';
        var messageContent = message;

        if (serverTimestampMatch) {
            serverTimestamp = `<span class="server-timestamp">${serverTimestampMatch[1]}</span>`;
            // 保留时间戳后的第一个空格
            messageContent = message.substring(serverTimestampMatch[0].length).trimStart();
        } else {
            // 本地时间戳（仅当服务器时间戳不存在时显示）
            var localTimestamp = `<span class="local-timestamp">[${new Date().toLocaleTimeString()}] </span>`;
            serverTimestamp = localTimestamp;
        }

        // 判断消息类型并设置整行颜色
        var messageType = '';
        if (messageContent.startsWith('[S]')) {
            messageType = 'type-S';
        } else if (messageContent.startsWith('[H]')) {
            messageType = 'type-H';
        }

        var div = document.createElement('div');
        if (messageType) {
            div.innerHTML = `${serverTimestamp} <span class="${messageType}">${messageContent}</span>`;
        } else {
            div.innerHTML = `${serverTimestamp} ${messageContent}`;
        }
        document.getElementById('messages').appendChild(div);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }
</script>
</body>
</html>